<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8" />
  <title>Core library tests</title>
  <link rel="stylesheet" href="css/qunit.css" />
  <script src="scripts/jquery.js"></script>
  <script src="scripts/qunit.js"></script>
  <script>
  var $L = function (key) {
          "use strict";

          return $L._messages[key.replace(/\./g, "_")];
      },
      SPRINGCRM = SPRINGCRM || {};

  $L._messages = {
          default_format_date: "dd.MM.yyyy",
          default_format_datetime: "dd.MM.yyyy HH:mm",
          default_format_time: "HH:mm"
      };
  </script>
  <script src="scripts/core.js"></script>
  <script>
  module("Numbers");
  test("Number formatting without precision", function () {
      equal((45).format(), "45");
      equal((-45).format(), "-45");
      equal((45.123).format(), "45,123");
      equal((-45.123).format(), "-45,123");
      equal((.123456).format(), "0,123456");
      equal((-.123456).format(), "-0,123456");
      equal((1234567.123).format(), "1.234.567,123");
      equal((-1234567.123).format(), "-1.234.567,123");
      equal((123456.123).format(), "123.456,123");
      equal((-123456.123).format(), "-123.456,123");
      equal((0 / 0).format(), "---");
  });

  test("Number formatting with null precision", function () {
      var n = null;

      equal((45).format(n), "45");
      equal((-45).format(n), "-45");
      equal((45.123).format(n), "45,123");
      equal((-45.123).format(n), "-45,123");
      equal((.123456).format(n), "0,123456");
      equal((-.123456).format(n), "-0,123456");
      equal((1234567.123).format(n), "1.234.567,123");
      equal((-1234567.123).format(n), "-1.234.567,123");
      equal((123456.123).format(n), "123.456,123");
      equal((-123456.123).format(n), "-123.456,123");
      equal((0 / 0).format(n), "---");
  });

  test("Number formatting with precision", function () {
      var n = 2;

      equal((45).format(n), "45,00");
      equal((-45).format(n), "-45,00");
      equal((45.123).format(n), "45,12");
      equal((45.128).format(n), "45,13");
      equal((-45.123).format(n), "-45,12");
      equal((-45.128).format(n), "-45,13");
      equal((.123456).format(n), "0,12");
      equal((-.123456).format(n), "-0,12");
      equal((1234567.123).format(n), "1.234.567,12");
      equal((-1234567.123).format(n), "-1.234.567,12");
      equal((123456.123).format(n), "123.456,12");
      equal((-123456.123).format(n), "-123.456,12");
      equal((0 / 0).format(n), "---");
      equal(Number.MIN_VALUE.format(n), "0,00");
      equal(Number.POSITIVE_INFINITY.format(n), "---");
      equal(Number.NEGATIVE_INFINITY.format(n), "---");
  });

  test("Number formatting with negative precision", function () {
      var n = -2;

      equal((45).format(n), "45,00");
      equal((-45).format(n), "-45,00");
      equal((45.123).format(n), "45,12");
      equal((45.128).format(n), "45,13");
      equal((-45.123).format(n), "-45,12");
      equal((-45.128).format(n), "-45,13");
      equal((.123456).format(n), "0,12");
      equal((-.123456).format(n), "-0,12");
      equal((1234567.123).format(n), "1.234.567,12");
      equal((-1234567.123).format(n), "-1.234.567,12");
      equal((123456.123).format(n), "123.456,12");
      equal((-123456.123).format(n), "-123.456,12");
      equal((0 / 0).format(n), "---");
      equal(Number.MIN_VALUE.format(n), "0,00");
      equal(Number.POSITIVE_INFINITY.format(n), "---");
      equal(Number.NEGATIVE_INFINITY.format(n), "---");
  });

  test("Number formatting with string precision", function () {
      var n = "2";

      equal((45).format(n), "45,00");
      equal((-45).format(n), "-45,00");
      equal((45.123).format(n), "45,12");
      equal((45.128).format(n), "45,13");
      equal((-45.123).format(n), "-45,12");
      equal((-45.128).format(n), "-45,13");
      equal((.123456).format(n), "0,12");
      equal((-.123456).format(n), "-0,12");
      equal((1234567.123).format(n), "1.234.567,12");
      equal((-1234567.123).format(n), "-1.234.567,12");
      equal((123456.123).format(n), "123.456,12");
      equal((-123456.123).format(n), "-123.456,12");
      equal((0 / 0).format(n), "---");
      equal(Number.MIN_VALUE.format(n), "0,00");
      equal(Number.POSITIVE_INFINITY.format(n), "---");
      equal(Number.NEGATIVE_INFINITY.format(n), "---");
  });

  test("Currency value formatting", function () {
      equal((45).formatCurrencyValue(), "45,00");
      equal((-45).formatCurrencyValue(), "-45,00");
      equal((45.123).formatCurrencyValue(), "45,12");
      equal((45.128).formatCurrencyValue(), "45,13");
      equal((-45.123).formatCurrencyValue(), "-45,12");
      equal((-45.128).formatCurrencyValue(), "-45,13");
      equal((.123456).formatCurrencyValue(), "0,12");
      equal((-.123456).formatCurrencyValue(), "-0,12");
      equal((1234567.123).formatCurrencyValue(), "1.234.567,12");
      equal((-1234567.123).formatCurrencyValue(), "-1.234.567,12");
      equal((123456.123).formatCurrencyValue(), "123.456,12");
      equal((-123456.123).formatCurrencyValue(), "-123.456,12");
      equal((0 / 0).formatCurrencyValue(), "---");
      equal(Number.MIN_VALUE.formatCurrencyValue(), "0,00");
      equal(Number.POSITIVE_INFINITY.formatCurrencyValue(), "---");
      equal(Number.NEGATIVE_INFINITY.formatCurrencyValue(), "---");
  });

  test("Number parsing", function () {
      equal("45".parseNumber(), 45);
      equal("45,".parseNumber(), 45);
      equal("45,00".parseNumber(), 45);
      equal("45,123".parseNumber(), 45.123);
      equal("1.234.567,123".parseNumber(), 1234567.123);
      equal("-45".parseNumber(), -45);
      equal("-45,00".parseNumber(), -45);
      equal("-45,123".parseNumber(), -45.123);
      equal("-1.234.567,123".parseNumber(), -1234567.123);
      equal("0,123456".parseNumber(), 0.123456);
      equal("-0,123456".parseNumber(), -0.123456);
      equal(",123456".parseNumber(), 0.123456);
      equal("-,123456".parseNumber(), -0.123456);
  });

  test("Number rounding", function () {
      equal((45).round(2), 45);
      equal((45.1).round(2), 45.1);
      equal((45.12).round(2), 45.12);
      equal((45.123).round(2), 45.12);
      equal((45.128).round(2), 45.13);
      equal((45.128).round(3), 45.128);
      equal((45.12345678901).round(3), 45.123);
      equal((45.12398765432).round(3), 45.124);
      equal((0).round(2), 0);
      equal(Number.MIN_VALUE.round(2), 0);
      ok(isNaN((0 / 0).round(2)));
  });


  module("Regular expressions");
  test("Regular expression escaping", function () {
      equal(RegExp.escape("."), "\\.");
      equal(RegExp.escape("[abc]"), "\\[abc\\]");
      equal(RegExp.escape("{abc}"), "\\{abc\\}");
      equal(RegExp.escape("1+4"), "1\\+4");
      equal(RegExp.escape("What?"), "What\\?");
      equal(RegExp.escape("Hat^"), "Hat\\^");
      equal(RegExp.escape("1.000.000 $"), "1\\.000\\.000 \\$");
      equal(RegExp.escape("\\"), "\\\\");
      equal(RegExp.escape("/"), "\\/");
  });


  module("Date and time");
  test("Date formatting", function () {
      var d = new Date(2012, 11, 29, 22, 28, 0, 0);

      equal(d.format("yy"), "12");
      equal(d.format("yyy"), "2012");
      equal(d.format("yyyy"), "2012");
      equal(d.format("MM.yyyy"), "12.2012");
      equal(d.format("yyyy-MM"), "2012-12");
      equal(d.format("dd.MM.yyyy"), "29.12.2012");
      equal(d.format("dd.MM.yyyy HH:mm"), "29.12.2012 22:28");
      equal(d.format("date"), "29.12.2012");
      equal(d.format("datetime"), "29.12.2012 22:28");
      equal(d.format("time"), "22:28");
      equal(d.format(), "29.12.2012 22:28");

      d = new Date(1980, 2, 7, 9, 5, 0, 0);
      equal(d.format("d.M.yy H:m"), "7.3.80 9:5");
  });

  test("Date parsing", function () {
      equal("2012".parseDate("yyyy").getTime(), new Date(2012, 0, 1, 0, 0, 0, 0).getTime());
      equal("12.2012".parseDate("MM.yyyy").getTime(), new Date(2012, 11, 1, 0, 0, 0, 0).getTime());
      equal("2012-12".parseDate("yyyy-MM").getTime(), new Date(2012, 11, 1, 0, 0, 0, 0).getTime());
      equal("29.12.2012".parseDate("dd.MM.yyyy").getTime(), new Date(2012, 11, 29, 0, 0, 0, 0).getTime());
      equal("29.12.2012 22:28".parseDate("dd.MM.yyyy HH:mm").getTime(), new Date(2012, 11, 29, 22, 28, 0, 0).getTime());
      equal("29.12.2012".parseDate("date").getTime(), new Date(2012, 11, 29, 0, 0, 0, 0).getTime());
      equal("29.12.2012 22:28".parseDate("datetime").getTime(), new Date(2012, 11, 29, 22, 28, 0, 0).getTime());
      equal("22:28".parseDate("time").getTime(), new Date(1970, 0, 1, 22, 28, 0, 0).getTime());
      equal("29.12.2012 22:28".parseDate().getTime(), new Date(2012, 11, 29, 22, 28, 0, 0).getTime());
      equal("29.12.2012 22:28".parseDate("d.M.yyy H:m").getTime(), new Date(2012, 11, 29, 22, 28, 0, 0).getTime());
      equal("29.12.2012 22:28".parseDate("d.M.yy H:m").getTime(), new Date(2012, 11, 29, 22, 28, 0, 0).getTime());
      equal("29.12.2012 22:28".parseDate("d.M.y H:m").getTime(), new Date(2012, 11, 29, 22, 28, 0, 0).getTime());
  });


  module("URLs");
  test("Empty URL construction", function () {
      var url;

      url = new HttpUrl();
      equal(url.scheme, "http");
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, undefined);
      equal(url.port, undefined);
      equal(url.path, undefined);
      propEqual(url.query, {});
      equal(url.fragmentIdentifier, undefined);
  });

  test("URL parsing", function () {
      var url;

      url = new HttpUrl("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, "https");
      equal(url.userName, "jsmith");
      equal(url.password, "secret");
      equal(url.host, "www.example.com");
      equal(url.port, 8080);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("https://jsmith:secret@www.example.com/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, "https");
      equal(url.userName, "jsmith");
      equal(url.password, "secret");
      equal(url.host, "www.example.com");
      equal(url.port, 443);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("http://jsmith:secret@www.example.com/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, "http");
      equal(url.userName, "jsmith");
      equal(url.password, "secret");
      equal(url.host, "www.example.com");
      equal(url.port, 80);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("http://jsmith@www.example.com/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, "http");
      equal(url.userName, "jsmith");
      equal(url.password, undefined);
      equal(url.host, "www.example.com");
      equal(url.port, 80);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("http://www.example.com/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, "http");
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "www.example.com");
      equal(url.port, 80);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("jsmith:secret@www.example.com/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, undefined);
      equal(url.userName, "jsmith");
      equal(url.password, "secret");
      equal(url.host, "www.example.com");
      equal(url.port, undefined);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("www.example.com:8070/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "www.example.com");
      equal(url.port, 8070);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("www.example.com/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "www.example.com");
      equal(url.port, undefined);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("www.example.com/foo/bar#part-1");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "www.example.com");
      equal(url.port, undefined);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("www.example.com/foo/bar");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "www.example.com");
      equal(url.port, undefined);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {});
      equal(url.fragmentIdentifier, undefined);

      url = new HttpUrl("www.example.com?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "www.example.com");
      equal(url.port, undefined);
      equal(url.path, "");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("www.example.com?attr1=wheezy%3dgib&attr2=jolly+funky");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "www.example.com");
      equal(url.port, undefined);
      equal(url.path, "");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, undefined);

      url = new HttpUrl("www.example.com");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "www.example.com");
      equal(url.port, undefined);
      equal(url.path, "");
      propEqual(url.query, {});
      equal(url.fragmentIdentifier, undefined);
  });

  test("URL parsing without host", function () {
      var url;

      url = new HttpUrl("/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "");
      equal(url.port, undefined);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("/foo/bar#part-1");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "");
      equal(url.port, undefined);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("/foo/bar");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "");
      equal(url.port, undefined);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {});
      equal(url.fragmentIdentifier, undefined);

      url = new HttpUrl("foo/bar");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "foo");
      equal(url.port, undefined);
      equal(url.path, "/bar");
      propEqual(url.query, {});
      equal(url.fragmentIdentifier, undefined);

      url = new HttpUrl("?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "");
      equal(url.port, undefined);
      equal(url.path, "");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");

      url = new HttpUrl("?attr1=wheezy%3dgib&attr2=jolly+funky");
      equal(url.scheme, undefined);
      equal(url.userName, undefined);
      equal(url.password, undefined);
      equal(url.host, "");
      equal(url.port, undefined);
      equal(url.path, "");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, undefined);
  });

  test("IDN URL parsing", function () {
      var url;

      url = new HttpUrl("https://jsmith:secret@www.gäßler.com:8080/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      equal(url.scheme, "https");
      equal(url.userName, "jsmith");
      equal(url.password, "secret");
      equal(url.host, "www.gäßler.com");
      equal(url.port, 8080);
      equal(url.path, "/foo/bar");
      propEqual(url.query, {attr1: 'wheezy=gib', attr2: 'jolly funky'});
      equal(url.fragmentIdentifier, "part-1");
  });

  test("URL building", function () {
      var url;

      url = new HttpUrl();
      url.host = "www.example.com";
      equal("http://www.example.com", url.toString());

      url = new HttpUrl();
      url.scheme = "https";
      url.host = "www.example.com";
      equal("https://www.example.com", url.toString());

      url = new HttpUrl();
      url.host = "www.example.com";
      url.port = 8080;
      equal("http://www.example.com:8080", url.toString());

      url = new HttpUrl();
      url.scheme = 'https';
      url.host = "www.example.com";
      url.port = 8080;
      equal("https://www.example.com:8080", url.toString());

      url = new HttpUrl();
      url.userName = 'jsmith';
      url.host = "www.example.com";
      equal("http://jsmith@www.example.com", url.toString());

      url = new HttpUrl();
      url.userName = 'jsmith';
      url.password = 'secret';
      url.host = "www.example.com";
      equal("http://jsmith:secret@www.example.com", url.toString());

      url = new HttpUrl();
      url.userName = 'jsmith';
      url.password = 'secret';
      url.host = "www.example.com";
      url.port = 8070;
      equal("http://jsmith:secret@www.example.com:8070", url.toString());

      url = new HttpUrl();
      url.host = "www.example.com";
      url.path = '/foo/bar';
      equal("http://www.example.com/foo/bar", url.toString());

      url = new HttpUrl();
      url.scheme = 'https';
      url.host = "www.example.com";
      url.path = '/foo/bar';
      equal("https://www.example.com/foo/bar", url.toString());

      url = new HttpUrl();
      url.scheme = 'https';
      url.host = "www.example.com";
      url.port = 8080;
      url.path = '/foo/bar';
      equal("https://www.example.com:8080/foo/bar", url.toString());

      url = new HttpUrl();
      url.host = "www.example.com";
      url.query = {attr1: 'wheezy=gib/thee', attr2: 'jolly funky'};
      equal("http://www.example.com?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky", url.toString());

      url = new HttpUrl();
      url.host = "www.example.com";
      url.path = '/foo/bar';
      url.query = {attr1: 'wheezy=gib/thee', attr2: 'jolly funky'};
      equal("http://www.example.com/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky", url.toString());

      url = new HttpUrl();
      url.scheme = 'https';
      url.host = "www.example.com";
      url.path = '/foo/bar';
      url.query = {attr1: 'wheezy=gib/thee', attr2: 'jolly funky'};
      equal("https://www.example.com/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky", url.toString());

      url = new HttpUrl();
      url.scheme = 'https';
      url.host = "www.example.com";
      url.port = 8080;
      url.path = '/foo/bar';
      url.query = {attr1: 'wheezy=gib/thee', attr2: 'jolly funky'};
      equal("https://www.example.com:8080/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky", url.toString());

      url = new HttpUrl();
      url.host = "www.example.com";
      url.fragmentIdentifier = "part-1";
      equal("http://www.example.com#part-1", url.toString());

      url = new HttpUrl();
      url.host = "www.example.com";
      url.path = '/foo/bar';
      url.fragmentIdentifier = "part-1";
      equal("http://www.example.com/foo/bar#part-1", url.toString());

      url = new HttpUrl();
      url.scheme = 'https';
      url.host = "www.example.com";
      url.path = '/foo/bar';
      url.fragmentIdentifier = "part-1";
      equal("https://www.example.com/foo/bar#part-1", url.toString());

      url = new HttpUrl();
      url.scheme = 'https';
      url.host = "www.example.com";
      url.port = 8080;
      url.path = '/foo/bar';
      url.fragmentIdentifier = "part-1";
      equal("https://www.example.com:8080/foo/bar#part-1", url.toString());

      url = new HttpUrl();
      url.scheme = 'https';
      url.host = "www.example.com";
      url.port = 8080;
      url.path = '/foo/bar';
      url.query = {attr1: 'wheezy=gib/thee', attr2: 'jolly funky'};
      url.fragmentIdentifier = "part-1";
      equal("https://www.example.com:8080/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1", url.toString());
  });

  test("Parsing and building", function () {
      var url;

      url = "https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "https://jsmith@www.example.com:8080/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "https://www.example.com:8080/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "http://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "http://jsmith@www.example.com:8080/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "http://www.example.com:8080/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "https://www.example.com/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "http://www.example.com/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "https://www.example.com?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "http://www.example.com?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "https://www.example.com/foo/bar#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "http://www.example.com/foo/bar#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "https://www.example.com?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky";
      equal(url, new HttpUrl(url).toString());

      url = "http://www.example.com?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky";
      equal(url, new HttpUrl(url).toString());

      url = "https://www.example.com/foo/bar";
      equal(url, new HttpUrl(url).toString());

      url = "http://www.example.com/foo/bar";
      equal(url, new HttpUrl(url).toString());

      url = "https://www.example.com";
      equal(url, new HttpUrl(url).toString());

      url = "http://www.example.com";
      equal(url, new HttpUrl(url).toString());

      url = "www.example.com";
      equal(url, new HttpUrl(url).toString());

      url = "/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "/foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky";
      equal(url, new HttpUrl(url).toString());

      url = "/foo/bar#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "foo/bar?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky#part-1";
      equal(url, new HttpUrl(url).toString());

      url = "?attr1=wheezy%3Dgib%2Fthee&attr2=jolly%20funky";
      equal(url, new HttpUrl(url).toString());

      url = "#part-1";
      equal(url, new HttpUrl(url).toString());
  });

  test("Overwrite query parameters", function () {
      var url;

      url = new HttpUrl("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      url.query.attr3 = 'buzz';
      equal("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3Dgib&attr2=jolly%20funky&attr3=buzz#part-1", url.toString());

      url = new HttpUrl("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      $.extend(url.query, {attr1: 'buzzy', attr3: 'gobbish'});
      equal("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=buzzy&attr2=jolly%20funky&attr3=gobbish#part-1", url.toString());

      url = new HttpUrl("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      delete url.query.attr1
      equal("https://jsmith:secret@www.example.com:8080/foo/bar?attr2=jolly%20funky#part-1", url.toString());

      url = new HttpUrl("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      url.overwriteQuery({attr3: 'buzz'});
      equal("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3Dgib&attr2=jolly%20funky&attr3=buzz#part-1", url.toString());

      url = new HttpUrl("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      url.overwriteQuery({attr1: 'buzzy', attr3: 'gobbish'});
      equal("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=buzzy&attr2=jolly%20funky&attr3=gobbish#part-1", url.toString());

      url = new HttpUrl("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      url.overwriteQuery("attr3=buzz");
      equal("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3Dgib&attr2=jolly%20funky&attr3=buzz#part-1", url.toString());

      url = new HttpUrl("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=wheezy%3dgib&attr2=jolly+funky#part-1");
      url.overwriteQuery("attr1=buzzy&attr3=gobbish");
      equal("https://jsmith:secret@www.example.com:8080/foo/bar?attr1=buzzy&attr2=jolly%20funky&attr3=gobbish#part-1", url.toString());
  });
  </script>
</head>

<body>
  <div id="qunit"></div>
</body>
</html>