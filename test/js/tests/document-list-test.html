<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8" />
  <title>Document list widget (documentlist) tests</title>
  <link rel="stylesheet" href="css/qunit.css" />
  <link rel="stylesheet" href="css/document.css" />
  <script src="scripts/jquery.js"></script>
  <script src="scripts/jquery.mockjax.js"></script>
  <script src="scripts/core.js"></script>
  <script src="scripts/filetype.js"></script>
  <script>
  var $L = function (key) {
          "use strict";

          return $L._messages[key.replace(/\./g, "_")];
      },
      SPRINGCRM = SPRINGCRM || {};

  $L._messages = {
      document_back_label: "back",
      document_path_label: "Path",
      document_path_root: "Root folder"
  };
  </script>
  <script src="scripts/document-list.js"></script>
</head>

<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <div id="dl3" class="auto-document-list" data-list="document"></div>
  <div id="dl4" class="auto-document-list" data-list="document" data-list-url="/springcrm/document/list"></div>

  <script src="scripts/qunit.js"></script>
  <script>

  "use strict";

  var BASE_URL = "/springcrm/document/list",
      checkFooFolder,
      checkRootFolder;


  /* QUnit extensions */
  QUnit.assert.textEqual = function ($element, text, message) {
      var actual = $element.text();

      QUnit.push(actual == text, actual, text, message);
  };
  QUnit.assert.is = function ($element, selector, message) {
      var ok = $element.is(selector);

      QUnit.push(ok, ok, true, message);
  };
  QUnit.assert.itemSize = function ($element, size, message) {
      var actual = $element.length;

      QUnit.push(actual == size, actual, size, message);
  };

  /* fixtures */
  $.mockjax({
      data: {
          path: ""
      },
      responseText: {
          folders: [
              { name: "bar", readable: true, writable: true },
              { name: "foo", readable: true, writable: true }
          ],
          files: [
              {
                  name: "baz.txt", ext: "txt", size: 20405,
                  readable: true, writable: true
              },
              {
                  name: "yummy.csv", ext: "csv", size: 40307430,
                  readable: true, writable: true
              }
          ]
      },
      responseTime: 10,
      url: BASE_URL
  });
  $.mockjax({
      data: {
          path: "foo"
      },
      responseText: {
         folders: [
             { name: "wheezy", readable: true, writable: true }
         ],
         files: [
             {
                 name: "hello-world.md", ext: "md", size: 303122,
                 readable: false, writable: true
             },
             {
                 name: "hello-world.c", ext: "c", size: 749393,
                 readable: true, writable: true
             }
         ]
      },
      responseTime: 10,
      url: BASE_URL
  });
  $.mockjax({
      data: {
          path: "foo/wheezy"
      },
      responseText: {
         folders: [],
         files: [
             {
                 name: "README.md", ext: "md", size: 403720,
                 readable: true, writable: true
             },
             {
                 name: "Documentation.odt", ext: "odt", size: 1023034,
                 readable: true, writable: true
             }
         ]
      },
      responseTime: 10,
      url: BASE_URL
  });


  /* feature tests */
  QUnit.module("Document list widget");
  QUnit.test("Instantiate widget without loading", function (assert) {
      var $dl,
          $fixture = $("#qunit-fixture");

      $fixture.append('\
        <div id="dl1" class="document-list"></div>\
        <div id="dl2" class="document-list" data-list-url="/springcrm/document/list"></div>\
      ');

      $dl = $(".document-list");
      $dl.documentlist();

      assert.equal($dl.html(), "", "both download lists are empty");
      assert.notEqual(
          $dl.data("bs.documentlist"), null,
          "both elements are marked as download-list"
      );
  });

  QUnit.test("Auto-configure widget without loading", function (assert) {
      assert.itemSize($("#dl3").children(), 0, "download list 3 is empty");
      assert.notEqual(
          $(".auto-document-list").data("bs.documentlist"), null,
          "both elements are marked as download-list"
      );
  });

  QUnit.asyncTest("Instantiate widget with loading", function (assert) {
      var $fixture = $("#qunit-fixture");

      expect(21);

      $fixture.append('\
        <div id="dl1" class="document-list"></div>\
        <div id="dl2" class="document-list" data-list-url="/springcrm/document/list"></div>\
      ');

      $(".document-list").documentlist();

      window.setTimeout(
          function () {
              checkRootFolder($("#dl1"), $("#dl2"), assert);
              QUnit.start();
          }, 30
      );
  });

  QUnit.asyncTest("Auto-configure widget with loading", function (assert) {
      expect(21);

      window.setTimeout(
          function () {
              checkRootFolder($("#dl3"), $("#dl4"), assert);
              QUnit.start();
          }, 30
      );
  });

  QUnit.asyncTest("Click on folder", function (assert) {
      var $dl,
          $fixture = $("#qunit-fixture");

      expect(20);

      $fixture.append('\
        <div id="dl1" class="document-list"></div>\
        <div id="dl2" class="document-list" data-list-url="/springcrm/document/list"></div>\
      ');

      $(".document-list").documentlist();

      window.setTimeout(
          function () {
              $("#dl2 > ul > li:nth-child(2)").click()
          }, 30
      );

      window.setTimeout(
          function () {
              checkFooFolder($("#dl1"), $("#dl2"), assert);
              QUnit.start();
          }, 60
      );
  });

  QUnit.asyncTest("Click on two folders", function (assert) {
      var $dl,
          $fixture = $("#qunit-fixture");

      expect(17);

      $fixture.append('\
        <div id="dl1" class="document-list"></div>\
        <div id="dl2" class="document-list" data-list-url="/springcrm/document/list"></div>\
      ');

      $dl = $(".document-list");
      $dl.documentlist();

      window.setTimeout(
          function () {
              $("#dl2 > ul > li:nth-child(2)").click()
          }, 30
      );

      window.setTimeout(
          function () {
              $("#dl2 > ul > li:nth-child(2)").click()
          }, 60
      );

      window.setTimeout(
          function () {
              var $li,
                  $lis,
                  $ul = $("#dl2 > ul");

              assert.itemSize($("#dl1 > ul"), 0, "download list 1 is empty");

              $lis = $ul.find("> li");
              assert.is($ul, ".document-list-container", "has class 'document-list-container'");

              assert.itemSize($ul, 1, "exactly 1 <ul> element");
              assert.itemSize($lis, 3, "exactly 3 <li> elements inside");

              $li = $lis.eq(0);
              assert.is($li, ".back-link", "item 1 has class 'back-link'");
              assert.itemSize($li.find("> i"), 1, "item 1 has an icon");
              assert.textEqual($li.find("> .name"), "back", "item 1 is called 'back'");
              $li = $lis.eq(1);
              assert.is($li, ".file", "item 2 has class 'file'");
              assert.is($li, ".filetype-text", "item 2 is a text file");
              assert.itemSize($li.find("> i"), 1, "item 2 has an icon");
              assert.textEqual($li.find("> .name"), "README.md", "item 2 is called 'README.md'");
              assert.textEqual($li.find("> .size"), "394,3 KB", "item 2 has a size of 394,3 KB");
              $li = $lis.eq(2);
              assert.is($li, ".file", "item 3 has class 'file'");
              assert.is($li, ".filetype-document", "item 3 is a text document file");
              assert.itemSize($li.find("> i"), 1, "item 3 has an icon");
              assert.textEqual($li.find("> .name"), "Documentation.odt", "item 3 is called 'Documentation.odt'");
              assert.textEqual($li.find("> .size"), "999,1 KB", "item 3 has a size of 999,1 KB");

              QUnit.start();
          }, 90
      );
  });

  QUnit.asyncTest("Click on back link", function (assert) {
      var $dl,
          $fixture = $("#qunit-fixture");

      expect(21);

      $fixture.append('\
        <div id="dl1" class="document-list"></div>\
        <div id="dl2" class="document-list" data-list-url="/springcrm/document/list"></div>\
      ');

      $dl = $(".document-list");
      $dl.documentlist();

      window.setTimeout(
          function () {
              $("#dl2 > ul > li:nth-child(2)").click()
          }, 30
      );

      window.setTimeout(
          function () {
              $("#dl2 > ul > .back-link").click()
          }, 60
      );

      window.setTimeout(
          function () {
              checkRootFolder($("#dl1"), $("#dl2"), assert);
              QUnit.start();
          }, 90
      );
  });

  QUnit.asyncTest("Click on two back links", function (assert) {
      var $dl,
          $fixture = $("#qunit-fixture");

      expect(41);

      $fixture.append('\
        <div id="dl1" class="document-list"></div>\
        <div id="dl2" class="document-list" data-list-url="/springcrm/document/list"></div>\
      ');

      $dl = $(".document-list");
      $dl.documentlist();

      window.setTimeout(
          function () {
              $("#dl2 > ul > li:nth-child(2)").click()
          }, 30
      );

      window.setTimeout(
          function () {
              $("#dl2 > ul > li:nth-child(2)").click()
          }, 60
      );

      window.setTimeout(
          function () {
              $("#dl2 > ul > .back-link").click()
          }, 90
      );

      window.setTimeout(
          function () {
              checkFooFolder($("#dl1"), $("#dl2"), assert);
          }, 120
      );

      window.setTimeout(
          function () {
              $("#dl2 > ul > .back-link").click()
          }, 150
      );

      window.setTimeout(
          function () {
              checkRootFolder($("#dl1"), $("#dl2"), assert);
              QUnit.start();
          }, 180
      );
  });

  checkFooFolder = function ($emptyList, $nonEmptyList, assert) {
      var $li,
          $lis,
          $ul = $nonEmptyList.children("ul");

      assert.itemSize($emptyList.children("ul"), 0, "download list 1 is empty");

      $lis = $ul.find("> li");
      assert.is($ul, ".document-list-container", "has class 'document-list-container'");

      assert.itemSize($ul, 1, "exactly 1 <ul> element");
      assert.itemSize($lis, 4, "exactly 4 <li> elements inside");

      $li = $lis.eq(0);
      assert.is($li, ".back-link", "item 1 has class 'back-link'");
      assert.itemSize($li.find("> i"), 1, "item 1 has an icon");
      assert.textEqual($li.find("> .name"), "back", "item 1 is called 'back'");
      $li = $lis.eq(1);
      assert.is($li, ".folder", "item 2 has class 'folder'");
      assert.itemSize($li.find("> i"), 1, "item 2 has an icon");
      assert.textEqual($li.find("> .name"), "wheezy", "item 1 is called 'wheezy'");
      $li = $lis.eq(2);
      assert.is($li, ".file", "item 3 has class 'file'");
      assert.is($li, ".filetype-text", "item 3 is a text file");
      assert.itemSize($li.find("> i"), 1, "item 3 has an icon");
      assert.textEqual($li.find("> .name"), "hello-world.md", "item 3 is called 'hello-world.md'");
      assert.textEqual($li.find("> .size"), "296,0 KB", "item 3 has a size of 296,0 KB");
      $li = $lis.eq(3);
      assert.is($li, ".file", "item 4 has class 'file'");
      assert.is($li, ".filetype-code", "item 4 is a code file");
      assert.itemSize($li.find("> i"), 1, "item 4 has an icon");
      assert.textEqual($li.find("> .name"), "hello-world.c", "item 4 is called 'hello-world.c'");
      assert.textEqual($li.find("> .size"), "731,8 KB", "item 4 has a size of 731,8 KB");
  };

  checkRootFolder = function ($emptyList, $nonEmptyList, assert) {
      var $li,
          $lis,
          $ul = $nonEmptyList.children("ul");

      assert.equal($emptyList.children("ul").length, 0, "download list 1 is empty");

      $lis = $ul.find("> li");
      assert.ok($ul.is(".document-list-container"), "has class 'document-list-container'");

      assert.itemSize($ul, 1, "exactly 1 <ul> element");
      assert.itemSize($lis, 4, "exactly 4 <li> elements inside");

      $li = $lis.eq(0);
      assert.is($li, ".folder", "item 1 has class 'folder'");
      assert.itemSize($li.find("> i"), 1, "item 1 has an icon");
      assert.textEqual($li.find("> .name"), "bar", "item 1 is called 'bar'");
      $li = $lis.eq(1);
      assert.is($li, ".folder", "item 2 has class 'folder'");
      assert.itemSize($li.find("> i"), 1, "item 2 has an icon");
      assert.textEqual($li.find("> .name"), "foo", "item 2 is called 'foo'");
      $li = $lis.eq(2);
      assert.is($li, ".file", "item 3 has class 'file'");
      assert.is($li, ".filetype-text", "item 3 is a text file");
      assert.itemSize($li.find("> i"), 1, "item 3 has an icon");
      assert.textEqual($li.find("> .name"), "baz.txt", "item 3 is called 'baz.txt'");
      assert.textEqual($li.find("> .size"), "19,9 KB", "item 3 has a size of 19,9 KB");
      $li = $lis.eq(3);
      assert.is($li, ".file", "item 4 has class 'file'");
      assert.is($li, ".filetype-spreadsheet", "item 4 is a spreadsheet file");
      assert.itemSize($li.find("> i"), 1, "item 4 has an icon");
      assert.textEqual($li.find("> .name"), "yummy.csv", "item 4 is called 'yummy.csv'");
      assert.textEqual($li.find("> .size"), "38,4 MB", "item 4 has a size of 38,4 MB");

      assert.notEqual(
          $emptyList.add($nonEmptyList).data("bs.documentlist"), null,
          "both document lists are marked as document-list"
      );
  };
  </script>
</body>
</html>